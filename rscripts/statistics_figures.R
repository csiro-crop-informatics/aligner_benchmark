#Alignment statistics are generated by parsing the output files
#parsing is done in rscripts/stats_parser.R

library(dplyr)
library(readr)
library(ggplot2)
library(viridis)
library(hrbrthemes)

stats <- read_csv("statistics/alignment_statistics.csv") %>% 
  mutate(query = case_when(
    grepl("V3", .$query) ~ "Adapters",
    !grepl("V3", .$query) ~ "No Adapters"
  )) %>% 
  group_by(paired, file) %>% 
  

#Get those that report percentages
stat_perc <- stats %>% 
  filter(perc)

ggplot(stats %>% filter(var == "total_read_accuracy"), aes(tool, value_dbl)) +
  geom_point(aes(colour = target)) + geom_line(aes(group = paste(type, target))) +
  facet_grid(paired~query)

ggplot(stats %>% filter(var == "unique_read_accuracy"), aes(tool, value_dbl)) +
  geom_point(aes(colour = target)) + geom_line(aes(group = paste(type, target))) +
  facet_grid(paired~query)

stats_prop <- stats %>% 
  filter(var %in% c("total_read_accuracy",
                    "perc_reads_incorrect",
                    "perc_reads_unaligned",
                    "perc_reads_ambiguous"),
         type == "single")

bar_p <- ggplot(stats_prop, aes(tool, value_dbl)) +
  geom_bar(aes(fill = var), stat = "identity") +
  facet_grid(target~query) +
  scale_fill_viridis(discrete = TRUE, direction = -1) +
  labs(title = "Read alignment statistics of biokanga and HiSAT2",
       subtitle = "Alignments of simulated reads",
       x = "Tool",
       y = "Percentage",
       fill = "Alignment classification") +
  theme_ipsum_rc()
bar_p

ggplot(stats_prop, aes(target, value_dbl)) +
  geom_line(aes(group = paste(tool, query), colour = tool, linetype = query), size = 1.15) +
  scale_color_brewer(palette = "Dark2") +
  # scale_color_viridis(option = "C", discrete = TRUE) +
  facet_wrap(~paste(var), scales = "free") +
  labs(title = "Read alignment statistics of biokanga and HiSAT2",
       subtitle = "Alignments of simulated reads",
       x = "Target",
       y = "Percentage",
       fill = "Alignment classification") +
  theme_ipsum_rc()

ggplot(stat_perc, aes(tool, value_dbl)) +
  geom_point(aes(colour = target, shape = paired)) + geom_line(aes(group = paste(type, target))) +
  facet_grid(query ~ var, scales = "free_y")

ggplot(stats %>% filter(grepl("incorrect", var)), aes(tool, value_dbl)) +
  geom_point(aes(colour = target, shape = var)) + geom_line(aes(group = paste(type, target, var))) +
  facet_grid(paired~query)

ggplot(stats %>% filter(grepl("accuracy", var)), aes(tool, value_dbl)) +
  geom_point(aes(colour = target, shape = var)) + geom_line(aes(group = paste(type, target, var))) +
  facet_grid(paired~query)

#biokanga t2/3 multi pairs are the same, check other stats
stats %>% 
  filter(target != "human_t1r1",
         tool == "biokanga",
         !grepl("total", var),
         type == "multi",
         paired == "pairs") %>% 
  arrange(var) %>% 
  print(n = nrow(.))

stats %>% 
  filter(!var %in% c("total_reads", "total_bases")) %>% 
  group_by(value_dbl) %>% 
  mutate(value_count = n()) %>% 
  filter(value_count > 1) %>% 
  group_by(value_dbl, value_count) %>% 
  filter(value_count < 5) %>% 
  summarise(file_combn = paste(file, collapse = ",")) %>% 
  group_by(file_combn) %>% 
  count()
arrange(value_count,value_dbl, var) %>% 
  print(n = nrow(.))
